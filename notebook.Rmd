---
title: "Conserve the Bees"
author: "F.J. Morales"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

Install packages
```{r install packages, eval=FALSE}
install.packages("tidyverse") #cleaning, exploring, analyzing and visualizing data
install.packages("rgbif") #communicating with GBIF API
install.packages("DBI") #connecting to a database server
install.packages("RPostgres") #communicating with PostgreSQL
install.packages("plotly") #making interactive graphs
```

Load libraries
```{r load libraries}
library(tidyverse)
library(rgbif)
library(DBI)
library(RPostgres)
library(plotly)
```

Store bee family names on a vector, get their **backbone** data and **taxonKey**
```{r family}
familyName <- c('Apidae', 'Halictidae', 'Megachilidae', 'Andrenidae', 'Colletidae', 'Melittidae', 'Stenotritidae')
familyBackbone <- name_backbone_checklist(familyName)
familyKey <- familyBackbone$usageKey
```

Get download from **GBIF** query and import it into ***RStudio***
```{r gbif}
gbifGet <- occ_download_get("0056337-231120084113126", path = ".", overwrite = FALSE)
gbifImport <- occ_download_import(gbifGet)
```

Connect with **PostgreSQL** database
```{r postgres}
postgres <- dbConnect(
  RPostgres::Postgres(),
  dbname = 'beeDB',
  host = 'localhost',
  port = 5432,
  user = rstudioapi::askForPassword("Please enter user:"),
  password = rstudioapi::askForPassword("Please enter password:")
  )
```

Store occurrence data on database
```{r create table, eval=FALSE}
dbWriteTable(pg, "occurrences", gbifImport)
```

Rename columns on database
```{sql rename columns, eval=FALSE}
ALTER TABLE occurrences
  RENAME COLUMN "gbifID" to gbifID_,
  RENAME COLUMN family to family_,
  RENAME COLUMN genus to genus_,
  RENAME COLUMN "scientificName" to scientificName_,
  RENAME COLUMN "stateProvince" to province_,
  RENAME COLUMN "individualCount" to count_,
  RENAME COLUMN "decimalLatitude" to latitude_,
  RENAME COLUMN "decimalLongitude" to longitude_,
  RENAME COLUMN "eventDate" to date_
```

Query the dataset into a **dataframe** and convert it into a **tibble**
```{r query}
occurrencesDataframe <- dbGetQuery(
  postgres,
  "SELECT
    gbifid_,
    family_,
    genus_,
    scientificName_,
    province_,
    count_,
    latitude_,
    longitude_,
    date_
  FROM
    occurrences
  WHERE
    status_ = 'PRESENT' AND
    date_ >= '1923-01-01 00:00:00' AND
    date_ <= '2023-12-31 23:59:59'
  ORDER BY
    date_ ASC"
  )

occurrencesTibble <- as_tibble(occurrencesDataframe)
str(occurrencesTibble)
```

_Mutate_ **date_** field to **date** type and **count_** field to replace nulls with 1
```{r mutate}
occurrencesTibble <- occurrencesTibble %>%
  mutate(
    date_ = as_date(date_),
    count_ = replace_na(count_, 1),
  )

occurrencesTibble$date_ <- occurrencesTibble$date_ %>%
  floor_date(unit = "month")

summaryDate <- tibble(
  family_ = occurrencesTibble$family_,
  count_ = occurrencesTibble$count_,
  date_ = occurrencesTibble$date_
  )

summaryDate <- summaryDate %>%
  group_by(year = year(date_), family = family_) %>%
  summarise(sum = sum(count_)) %>%
  mutate(percentage = sum / sum(sum))

# summaryDate <- summaryDate %>%
#   pivot_wider(
#     names_from = family_,
#     values_from = count_,
#     values_fn = sum,
#     values_fill = 0
#   )

head(summaryDate)
```

```{r}
plotDate <- ggplot(summaryDate) +
  geom_area(mapping = aes(year, percentage, fill = family))

plotDate
```

